var Revise=(()=>{var ie=Object.defineProperty;var Pe=t=>ie(t,"__esModule",{value:!0});var Se=(t,e)=>{Pe(t);for(var n in e)ie(t,n,{get:e[n],enumerable:!0})};var ze={};Se(ze,{Fragment:()=>we,InvariantError:()=>w,OnCollectionRelease:()=>le,VERSION:()=>Ae,calc:()=>De,collection:()=>Me,debug:()=>Ge,default:()=>_e,effect:()=>G,flush:()=>We,model:()=>$e,mount:()=>Ce,name:()=>W,ref:()=>ce,release:()=>U,reset:()=>Ue,retain:()=>A,setLogLevel:()=>fe,subscribe:()=>Le});var w=class extends Error{},v=Symbol("reviseType"),T=Symbol("calculationType");function se(t){return t&&t[v]==="ref"}function ce(t){return{[v]:"ref",current:t}}var le=Symbol("OnCollectionRelease");function de(t){return Object.assign(t,{[v]:"calculation",[T]:"calculation"})}function ae(t){return Object.assign(t,{[v]:"calculation",[T]:"effect"})}function K(t){return!!(t&&t[v]==="collection")}function M(t){return!!(t&&t[v]==="calculation")}function ue(t){return t[T]==="effect"}var V={error:0,warn:1,info:2,debug:3},X=V.warn;function fe(t){x(()=>t in V,t),X=V[t]}function E(...t){X>=V.debug&&console.log(...t)}function pe(...t){X>=V.warn&&console.warn(...t)}function m(...t){X>=V.error&&console.error(...t)}function q(t,...e){t instanceof Error?(m(t),m(...e)):m(t,...e)}function x(t,...e){t()||m("Invariant error",t.toString(),"is not truthy",...e)}function _(t,...e){if(!t)throw m("Assertion failure",t.toString(),"is not truthy",...e),new Error("Assertion failure")}function he(t,...e){throw m("Assertion failure",t,"is not exhausted",...e),new Error("Assertion failure")}var H={},y=t=>t===H;var S=class{constructor(){this.maxId=0,this.idMap=new WeakMap,this.nodes={},this.edgeMap={},this.reverseEdgeMap={},this.refCount={},this.cullableSet={},this._addNode(H),this.sentinelId=this.getItemId(H)}getItemId(e){let n;return(n=this.idMap.get(e))===void 0&&(n=this.maxId.toString(),this.maxId+=1,this.idMap.set(e,n)),n}addNode(e){return this._addNode(e)}_addNode(e){let n=this.getItemId(e);return this.nodes[n]?!1:(this.refCount[n]=0,y(e)||(this.cullableSet[n]=!0),this.nodes[n]=e,this.edgeMap[n]={},this.reverseEdgeMap[n]={},!0)}hasNode(e){return!!this.nodes[this.getItemId(e)]}addEdge(e,n){let r=this.getItemId(e),o=this.getItemId(n);return this._addEdge(r,o)}_addEdge(e,n){let r=this.nodes[e],o=this.nodes[n];return x(()=>e===this.sentinelId||!!this.nodes[e],"addEdge fromNode does not exist",r),x(()=>!!this.nodes[n],"addEdge toNode does not exist",o),this.edgeMap[e]||(this.edgeMap[e]={}),this.edgeMap[e][n]?!1:(this.edgeMap[e][n]=o,this.reverseEdgeMap[n]||(this.reverseEdgeMap[n]={}),this.reverseEdgeMap[n][e]=r,this.refCount[e]+=1,delete this.cullableSet[e],!0)}removeEdge(e,n){let r=this.getItemId(e),o=this.getItemId(n),i=this._removeEdge(r,o);return x(()=>i===!1,"removeEdge attempted on nonexistent edge",{fromNode:e,toNode:n}),i}removeNode(e){let n=this.getItemId(e);return this._removeNode(n)}_removeNode(e){if(!this.nodes[e])return!0;let n=this.nodes[e];return Object.keys(this.edgeMap[e]).forEach(r=>this._removeEdge(e,r)),Object.keys(this.reverseEdgeMap[e]).forEach(r=>this._removeEdge(r,e)),x(()=>this.refCount[e]===0,"still has refcount after deleting edges",n),x(()=>this.cullableSet[e]===!0,"not cullable after deleting edges",n),delete this.nodes[e],delete this.edgeMap[e],delete this.reverseEdgeMap[e],delete this.refCount[e],delete this.cullableSet[e],!1}_removeEdge(e,n){return _(!!this.edgeMap[e],"_removeEdge fromId not found in edgeMap",e),_(!!this.reverseEdgeMap[n],"_removeEdge toId not found in reverseEdgeMap",n),this.edgeMap[e][n]?(delete this.edgeMap[e][n],this.refCount[e]-=1,this.refCount[e]===0&&(this.cullableSet[e]=!0),delete this.reverseEdgeMap[n][e],!1):(m("_removeEdge edge not found",{fromId:e,toId:n}),!0)}retain(e){let n=this._addEdge(this.getItemId(e),this.sentinelId);x(()=>!!n,"double-retained",e)}release(e){let n=this._removeEdge(this.getItemId(e),this.sentinelId);x(()=>!n,"released a non-retained node",e)}removeEdges(e){e.forEach(([n,r])=>{let o=this.getItemId(n),i=this.getItemId(r);this._removeEdge(o,i)})}getDependencies(e){let n=this.getItemId(e);if(!this.edgeMap[n])return[];let r=[];return Object.values(this.edgeMap[n]).forEach(o=>{y(o)||r.push(o)}),r}getReverseDependencies(e){let n=this.getItemId(e);if(!this.reverseEdgeMap[n])return[];let r=[];return Object.values(this.reverseEdgeMap[n]).forEach(o=>{y(o)||r.push(o)}),r}visitTopological(e){let n={},r=[],o=i=>{if(n[i])return;n[i]=!0,Object.keys(this.edgeMap[i]||{}).forEach(d=>{o(d)});let s=this.nodes[i];y(s)||r.unshift(s)};Object.keys(this.nodes).forEach(i=>{o(i)}),r.forEach(i=>{e(i)})}garbageCollect(){let e=[];for(;Object.keys(this.cullableSet).length>0;)Object.keys(this.cullableSet).forEach(n=>{let r=this.nodes[n];_(!y(r),"tried to garbage collect sentinel"),e.push(r),this._removeNode(n)});return e}graphviz(e){let n=["digraph dag {"];return Object.entries(this.nodes).forEach(([r,o])=>{let i={label:y(o)?"<ROOT>":e(r,o)};y(o)&&(i.shape="circle"),n.push(`  item_${r} [${Object.entries(i).map(([s,d])=>`${s}=${JSON.stringify(d)}`).join(",")}];`)}),Object.entries(this.edgeMap).forEach(([r,o])=>{Object.keys(o).forEach(i=>{n.push(`  item_${r} -> item_${i};`)})}),n.push("}"),n.join(`
`)}};function ge(t){return!!(t&&typeof t=="object"&&"type"in t&&t.type==="element")}function me(t){return!!(t&&typeof t=="object"&&"type"in t&&t.type==="component")}var ee=Symbol("VNode");function Ee({domNode:t}){let e={domNode:t,children:[],parentNode:null,domParent:null,jsxNode:null,onUnmount:[],[ee]:!0};return e.domParent=e,e}function b({jsxNode:t,domNode:e,domParent:n,onUnmount:r,parentNode:o}){return{domNode:e,children:[],parentNode:o,domParent:n,jsxNode:t,onUnmount:r,[ee]:!0}}function F({parentNode:t,domParent:e}){return{domNode:null,children:[],parentNode:t,domParent:e,jsxNode:null,onUnmount:[],[ee]:!0}}function Oe(t){let e=[];function n(r){r.domNode?e.push(r.domNode):r.children.forEach(o=>n(o))}return n(t),e}function Ve(t,e,n){let r=0;function o(s){return s.domNode?(r+=1,!1):i(s)}function i(s){let d=s===e?n:s.children.length;for(let a=0;a<d;++a)if(o(s.children[a]))return!0;return s===e}return i(t),r}function be(t){t.children.forEach(e=>be(e)),t.onUnmount&&t.onUnmount.forEach(e=>{try{e()}catch(n){q(n,"VNode node raised exception in onUnmount",t)}})}function N(t,e){return te(t.parentNode,t,1,[e])[0]}function te(t,e,n,r){let o,i;e?(i=t.children.indexOf(e),i===-1&&(i=t.children.length),o=e.domParent):(i=t.children.length,o=t.domNode?t:t.domParent),_(o,"tried to replace a root tree slot with missing domParent");let s=t.children.splice(i,n,...r);if(s.forEach(a=>{be(a),Oe(a).forEach(f=>{f.parentNode&&f.parentNode.removeChild(f)})}),!o.domNode)throw new Error("Invariant: domParent missing domNode");let d=o.domNode;return r.forEach(a=>{if(a.parentNode=t,a.domParent=o,a.domNode){let g=Ve(o,t,i),f=d.childNodes[g];d.insertBefore(a.domNode,f||null)}}),s}function Ne(t,e,...n){return typeof t=="string"?{type:"element",element:t,props:e,children:n}:{type:"component",component:t,props:e,children:n}}var ve=new WeakMap;function xe(t,e,n){if(n==null||n===!1)t.removeAttribute(e);else if(n===!0)t.setAttribute(e,"");else if(typeof n=="string")t.setAttribute(e,n);else if(typeof n=="number")t.setAttribute(e,n.toString());else if(e.startsWith("on:")&&typeof n=="function"){let r=e.slice(3),o=ve.get(t);o||(o={},ve.set(t,o)),o[e]&&t.removeEventListener(r,o[e]),t.addEventListener(r,n),o[e]=n}}function Q({domParent:t,parentNode:e,jsxNode:n}){let r=F({domParent:t,parentNode:e});e.children.push(r),R({nodeToReplace:r,jsxNode:n})}function R({nodeToReplace:t,jsxNode:e}){if(e==null||e===!1||e===!0){let n=b({parentNode:t.parentNode,domParent:t.domParent,jsxNode:e,domNode:null,onUnmount:[]});return N(t,n),n}if(typeof e=="string"){let n=b({parentNode:t.parentNode,domParent:t.domParent,jsxNode:e,domNode:document.createTextNode(e),onUnmount:[]});return N(t,n),n}if(typeof e=="number"){let n=b({parentNode:t.parentNode,domParent:t.domParent,jsxNode:e,domNode:document.createTextNode(e.toString()),onUnmount:[]});return N(t,n),n}if(ge(e)){let n=document.createElement(e.element),r=[],o;e.props&&Object.entries(e.props).forEach(([s,d])=>{if(s==="ref"){if(se(d)){d.current=n;return}if(typeof d=="function"&&!M(d)){o=d;return}}if(M(d)){let a=W(G(()=>{let g=d();xe(n,s,g)}),`view:bindAttribute:${s}:`);A(a),r.push(a),a()}else xe(n,s,d)});let i=b({parentNode:t.parentNode,domParent:t.domParent,jsxNode:e,domNode:n,onUnmount:[()=>{r.forEach(s=>U(s)),o&&o(void 0)}]});return N(t,i),e.children.forEach(s=>{Q({domParent:i,parentNode:i,jsxNode:s})}),o&&o(n),i}if(K(e)){let n=e,r=[],o=b({parentNode:t.parentNode,domParent:t.domParent,jsxNode:e,domNode:null,onUnmount:r});N(t,o);let i=n.observe(s=>{if(s.type==="init"){let{items:d}=s;d.forEach(a=>{Q({domParent:o.domParent,parentNode:o,jsxNode:a})})}else if(s.type!=="sort"){if(s.type==="splice"){let{count:d,index:a,items:g}=s,f=g.map(()=>F({domParent:o.domParent,parentNode:o}));te(o,o.children[a],d,f),g.forEach((Z,k)=>{R({nodeToReplace:f[k],jsxNode:Z})})}}});return A(n),r.push(i),r.push(()=>{U(n)}),o}if(M(e)){let n=e,r=[],o=b({parentNode:t.parentNode,domParent:t.domParent,jsxNode:e,domNode:null,onUnmount:r});N(t,o);let i=F({parentNode:o,domParent:o.domParent});o.children.push(i);let s=W(G(()=>{let d=n();i=R({nodeToReplace:i,jsxNode:d})}),"view:calc:");return A(s),r.push(()=>U(s)),s(),o}if(me(e)){let n=[],r=b({parentNode:t.parentNode,domParent:t.domParent,jsxNode:e,domNode:null,onUnmount:n});N(t,r);let o=F({parentNode:r,domParent:r.domParent});r.children.push(o);let i=e.component,s=W(G(()=>{let d=[],a=[],g=i(Object.assign(Object.assign({},e.props||{}),{children:e.children}),{onUnmount:f=>{d.push(f)},onMount:f=>{a.push(f)}});o=R({nodeToReplace:o,jsxNode:g}),a.forEach(f=>f())}),`view:component:${e.component.name}:`);return A(s),n.push(()=>U(s)),s(),r}if(Array.isArray(e)){let n=e,r=b({parentNode:t.parentNode,domParent:t.domParent,jsxNode:e,domNode:null,onUnmount:[]});return N(t,r),n.forEach(o=>{Q({domParent:r.domParent,parentNode:r,jsxNode:o})}),r}if(typeof e=="function"){let n=b({parentNode:t.parentNode,domParent:t.domParent,jsxNode:e,domNode:null,onUnmount:[]});return N(t,n),pe("Attempted to render JSX node that was a function, not rendering anything"),n}he(e,"unexpected render type")}function Ce(t,e){let n=Ee({domNode:t});Q({domParent:n,parentNode:n,jsxNode:e})}var we=({children:t})=>t;var _e=Ne,Ae="development",z=[],ne=new Map,J=new WeakMap;function h(t){var e,n,r;return K(t)?`coll:${(e=J.get(t))!==null&&e!==void 0?e:"?"}`:M(t)?`${ue(t)?"eff":"comp"}:${(n=J.get(t))!==null&&n!==void 0?n:"?"}`:`model:${(r=J.get(t.model))!==null&&r!==void 0?r:"?"}:${String(t.key)}`}var $=new S,u=new S;function Ue(){$=new S,z=[],ne=new Map,u=new S,J=new WeakMap}function W(t,e){return J.set(t,e),t}function $e(t){if(typeof t!="object"||!t)throw new w("model must be provided an object");let e=new Map,n=new Proxy(t,{get(r,o){if(o===v)return"model";let i=e.get(o);return i||(i={model:n,key:o},e.set(o,i)),oe(i),r[o]},set(r,o,i){let s=e.get(o);return s||(s={model:n,key:o},e.set(o,s)),D(s),r[o]=i,!0}});return n}function Me(t){if(!Array.isArray(t))throw new w("collection must be provided an array");let e=new Map,n=[];function r(l){n.forEach(c=>{c(l)})}function o(l,c,...p){if(c<1&&p.length===0)return[];let C=t.length,L=t.splice(l,c,...p),B=t.length;if(r({type:"splice",index:l,count:c,items:p}),C===B)for(let P=l;P<l+c;++P)D(O(P.toString()));else{for(let P=l;P<Math.max(B,C);++P)D(O(P.toString()));D(O("length"))}return L}function i(){return o(t.length-1,1)[0]}function s(){return o(0,1)[0]}function d(...l){return o(t.length,0,...l),t.length}function a(...l){return o(0,0,...l),t.length}function g(l){return t.sort(l),n.forEach(c=>{c({type:"sort"})}),I}function f(l){let c=Me(t.map(l));return I.observe(p=>{if(p.type!=="sort"&&p.type==="splice"){let{index:C,count:L,items:B}=p;c.splice(C,L,...B.map(l))}}),c}function Z(l,c){o(l,1,c)}function k(l){return n.push(l),l({type:"init",items:t}),()=>{n=n.filter(c=>c!==l)}}let j={splice:o,pop:i,shift:s,push:d,unshift:a,observe:k,sort:g,mapView:f};function O(l){let c=e.get(l);return c||(c={model:I,key:l},e.set(l,c)),c}let I=new Proxy(t,{get(l,c){if(c in j)return j[c];if(c===v)return"collection";let p=O(c);return Ie(I,p),oe(p),l[c]},set(l,c,p){if(c in j)return m("Overriding certain collection methods not supported",c),!1;let C=Number(c);if(!isNaN(C)&&C<=t.length)return Z(C,p),!0;let L=O(c);return D(L),l[c]=p,!0},deleteProperty(l,c){if(c in j)return m("Deleting certain collection methods not supported",c),!1;let p=O(c);return D(p),delete l[c],!0}});return I}function De(t){return ye(t,!1)}function G(t){return ye(t,!0)}function ye(t,e){if(typeof t!="function")throw new w("calculation must be provided a function");let n,r=()=>{n=void 0},o=(e?ae:de)(function(){if(e||oe(o),n)return n.result;let s=u.getReverseDependencies(o).map(a=>[a,o]);if(u.removeEdges(s),z.push(o),n={result:t()},z.pop()!==o)throw new w("Active calculation stack inconsistency!");return n.result});return u.addNode(o),ne.set(o,r),o}function oe(t){let e=z[z.length-1];e&&(u.addNode(t),u.hasNode(e)||u.addNode(e),u.addEdge(t,e)&&E("New global dependency",h(t),"->",h(e)))}function Ie(t,e){u.addNode(t),u.addNode(e),u.addEdge(t,e)&&E("New global collection dependency",h(t),"->",h(e))}function D(t){let e=n=>{$.addNode(n),u.getDependencies(n).forEach(o=>{$.hasNode(o)||e(o),$.addEdge(n,o)&&E("New local dependency",h(t),"->",h(o)),Y||(Y=!0,Fe())})};e(t)}var Y=!1,re=new Set;function Le(t){return re.add(t),()=>re.delete(t)}function Fe(){re.forEach(t=>{try{t()}catch(e){q(e,"unhandled exception in subscriber")}})}function We(){if(!Y)return;Y=!1;let t=$;$=new S,t.visitTopological(e=>{if(M(e)){E("flushing calculation",h(e));let n=ne.get(e);n&&n(),e()}else E("flushing model",h(e))}),u.garbageCollect().forEach(e=>{M(e)?E("GC calculation",h(e)):E("GC model",h(e))})}function A(t){E("retain",h(t)),u.hasNode(t)||u.addNode(t),u.retain(t)}function U(t){E("release",h(t)),u.release(t)}function Ge(){return u.graphviz((t,e)=>`${t}
${h(e)}`)}return ze;})();
//# sourceMappingURL=index.min.js.map
