var Revise=(()=>{var oe=Object.defineProperty;var Ce=t=>oe(t,"__esModule",{value:!0});var we=(t,e)=>{Ce(t);for(var n in e)oe(t,n,{get:e[n],enumerable:!0})};var Le={};we(Le,{Fragment:()=>ve,InvariantError:()=>T,OnCollectionRelease:()=>se,VERSION:()=>Se,calc:()=>Ue,collection:()=>Ne,debug:()=>Pe,default:()=>Oe,effect:()=>V,flush:()=>De,model:()=>je,mount:()=>be,name:()=>J,ref:()=>ie,release:()=>R,reset:()=>_e,retain:()=>A,setLogLevel:()=>ae,subscribe:()=>Ae});var T=class extends Error{},w=Symbol("reviseType"),Y=Symbol("calculationType");function re(t){return t&&t[w]==="ref"}function ie(t){return{[w]:"ref",current:t}}var se=Symbol("OnCollectionRelease");function ce(t){return Object.assign(t,{[w]:"calculation",[Y]:"calculation"})}function le(t){return Object.assign(t,{[w]:"calculation",[Y]:"effect"})}function B(t){return!!(t&&t[w]==="collection")}function y(t){return!!(t&&t[w]==="calculation")}function de(t){return t[Y]==="effect"}var G={error:0,warn:1,info:2,debug:3},Z=G.warn;function ae(t){M(()=>t in G,t),Z=G[t]}function N(...t){Z>=G.debug&&console.log(...t)}function b(...t){Z>=G.error&&console.error(...t)}function K(t,...e){t instanceof Error?(b(t),b(...e)):b(t,...e)}function M(t,...e){t()||b("Invariant error",t.toString(),"is not truthy",...e)}function q(t,...e){if(!t)throw b("Assertion failure",t.toString(),"is not truthy",...e),new Error("Assertion failure")}function ue(t,...e){throw b("Assertion failure",t,"is not exhausted",...e),new Error("Assertion failure")}var H={},O=t=>t===H;var _=class{constructor(){this.maxId=0,this.idMap=new WeakMap,this.nodes={},this.edgeMap={},this.reverseEdgeMap={},this.refCount={},this.cullableSet={},this._addNode(H),this.sentinelId=this.getItemId(H)}getItemId(e){let n;return(n=this.idMap.get(e))===void 0&&(n=this.maxId.toString(),this.maxId+=1,this.idMap.set(e,n)),n}addNode(e){return this._addNode(e)}_addNode(e){let n=this.getItemId(e);return this.nodes[n]?!1:(this.refCount[n]=0,O(e)||(this.cullableSet[n]=!0),this.nodes[n]=e,this.edgeMap[n]={},this.reverseEdgeMap[n]={},!0)}hasNode(e){return!!this.nodes[this.getItemId(e)]}addEdge(e,n){let o=this.getItemId(e),r=this.getItemId(n);return this._addEdge(o,r)}_addEdge(e,n){let o=this.nodes[e],r=this.nodes[n];return M(()=>e===this.sentinelId||!!this.nodes[e],"addEdge fromNode does not exist",o),M(()=>!!this.nodes[n],"addEdge toNode does not exist",r),this.edgeMap[e]||(this.edgeMap[e]={}),this.edgeMap[e][n]?!1:(this.edgeMap[e][n]=r,this.reverseEdgeMap[n]||(this.reverseEdgeMap[n]={}),this.reverseEdgeMap[n][e]=o,this.refCount[e]+=1,delete this.cullableSet[e],!0)}removeEdge(e,n){let o=this.getItemId(e),r=this.getItemId(n),i=this._removeEdge(o,r);return M(()=>i===!1,"removeEdge attempted on nonexistent edge",{fromNode:e,toNode:n}),i}removeNode(e){let n=this.getItemId(e);return this._removeNode(n)}_removeNode(e){if(!this.nodes[e])return!0;let n=this.nodes[e];return Object.keys(this.edgeMap[e]).forEach(o=>this._removeEdge(e,o)),Object.keys(this.reverseEdgeMap[e]).forEach(o=>this._removeEdge(o,e)),M(()=>this.refCount[e]===0,"still has refcount after deleting edges",n),M(()=>this.cullableSet[e]===!0,"not cullable after deleting edges",n),delete this.nodes[e],delete this.edgeMap[e],delete this.reverseEdgeMap[e],delete this.refCount[e],delete this.cullableSet[e],!1}_removeEdge(e,n){return q(!!this.edgeMap[e],"_removeEdge fromId not found in edgeMap",e),q(!!this.reverseEdgeMap[n],"_removeEdge toId not found in reverseEdgeMap",n),this.edgeMap[e][n]?(delete this.edgeMap[e][n],this.refCount[e]-=1,this.refCount[e]===0&&(this.cullableSet[e]=!0),delete this.reverseEdgeMap[n][e],!1):(b("_removeEdge edge not found",{fromId:e,toId:n}),!0)}retain(e){let n=this._addEdge(this.getItemId(e),this.sentinelId);M(()=>!!n,"double-retained",e)}release(e){let n=this._removeEdge(this.getItemId(e),this.sentinelId);M(()=>!n,"released a non-retained node",e)}removeEdges(e){e.forEach(([n,o])=>{let r=this.getItemId(n),i=this.getItemId(o);this._removeEdge(r,i)})}getDependencies(e){let n=this.getItemId(e);if(!this.edgeMap[n])return[];let o=[];return Object.values(this.edgeMap[n]).forEach(r=>{O(r)||o.push(r)}),o}getReverseDependencies(e){let n=this.getItemId(e);if(!this.reverseEdgeMap[n])return[];let o=[];return Object.values(this.reverseEdgeMap[n]).forEach(r=>{O(r)||o.push(r)}),o}visitTopological(e){let n={},o=[],r=i=>{if(n[i])return;n[i]=!0,Object.keys(this.edgeMap[i]||{}).forEach(d=>{r(d)});let c=this.nodes[i];O(c)||o.unshift(c)};Object.keys(this.nodes).forEach(i=>{r(i)}),o.forEach(i=>{e(i)})}garbageCollect(){let e=[];for(;Object.keys(this.cullableSet).length>0;)Object.keys(this.cullableSet).forEach(n=>{let o=this.nodes[n];q(!O(o),"tried to garbage collect sentinel"),e.push(o),this._removeNode(n)});return e}graphviz(e){let n=["digraph dag {"];return Object.entries(this.nodes).forEach(([o,r])=>{let i={label:O(r)?"<ROOT>":e(o,r)};O(r)&&(i.shape="circle"),n.push(`  item_${o} [${Object.entries(i).map(([c,d])=>`${c}=${JSON.stringify(d)}`).join(",")}];`)}),Object.entries(this.edgeMap).forEach(([o,r])=>{Object.keys(r).forEach(i=>{n.push(`  item_${o} -> item_${i};`)})}),n.push("}"),n.join(`
`)}};function fe(t){return!!(t&&typeof t=="object"&&"type"in t&&t.type==="element")}function pe(t){return!!(t&&typeof t=="object"&&"type"in t&&t.type==="component")}var Me=Symbol("TreeSlot");function E({renderChild:t,domNode:e,onUnmount:n}){return{domNode:e,children:[],renderChild:t,onUnmount:n,[Me]:!0}}function I(t,e){if(!t.domNode)throw new Error("TreeSlot roots must have a DOM node");let n=t,o=t;for(let r=0;r<e.length-1;++r)n=n.children[e[r]],n.domNode&&(o=n);return{immediateParent:n,childIndex:e[e.length-1],domParent:o}}function Te(t){let e=[];function n(o){o.domNode?e.push(o.domNode):o.children.forEach(r=>n(r))}return n(t),e}function ye(t,e,n){let o=0;function r(c){return c.domNode?(o+=1,!1):i(c)}function i(c){let d=c===e?n:c.children.length;for(let f=0;f<d;++f)if(r(c.children[f]))return!0;return c===e}return i(t),o}function he(t){t.children.forEach(e=>he(e)),t.onUnmount&&t.onUnmount.forEach(e=>{try{e()}catch(n){K(n,"TreeSlot node raised exception in onUnmount",t)}})}function x(t,e,n){return k(t,e,1,[n])[0]}function k(t,e,n,o){let{immediateParent:r,childIndex:i,domParent:c}=I(t,e),d=r.children.splice(i,n,...o);if(d.forEach(u=>{he(u),Te(u).forEach(p=>{p.parentNode&&p.parentNode.removeChild(p)})}),!c.domNode)throw new Error("Invariant: domParent missing domNode");let f=c.domNode;return o.forEach(u=>{if(u.domNode){let a=ye(c,r,i),p=f.childNodes[a];f.insertBefore(u.domNode,p||null)}}),d}function ge(t,e,...n){return typeof t=="string"?{type:"element",element:t,props:e,children:n}:{type:"component",component:t,props:e,children:n}}var me=new WeakMap;function Ee(t,e,n){if(n==null||n===!1)t.removeAttribute(e);else if(n===!0)t.setAttribute(e,"");else if(typeof n=="string")t.setAttribute(e,n);else if(typeof n=="number")t.setAttribute(e,n.toString());else if(e.startsWith("on:")&&typeof n=="function"){let o=e.slice(3),r=me.get(t);r||(r={},me.set(t,r)),r[e]&&t.removeEventListener(o,r[e]),t.addEventListener(o,n),r[e]=n}}function j({parentElement:t,treeSlot:e,mountIndex:n,root:o,replacedTreeSlot:r}){if(o==null||o===!1||o===!0){x(e,n,E({renderChild:o,domNode:null,onUnmount:[]}));return}if(typeof o=="string"){x(e,n,E({renderChild:o,domNode:document.createTextNode(o),onUnmount:[]}));return}if(typeof o=="number"){x(e,n,E({renderChild:o,domNode:document.createTextNode(o.toString()),onUnmount:[]}));return}if(fe(o)){let i=document.createElement(o.element),c=[],d;o.props&&Object.entries(o.props).forEach(([u,a])=>{if(u==="ref"){if(re(a)){a.current=i;return}if(typeof a=="function"&&!y(a)){d=a;return}}if(y(a)){let p=J(V(()=>{let U=a();Ee(i,u,U)}),`view:bindAttribute:${u}:${JSON.stringify(n)}`);A(p),c.push(p),p()}else Ee(i,u,a)});let f=E({renderChild:o,domNode:i,onUnmount:[()=>{c.forEach(u=>R(u)),d&&d(void 0)}]});x(e,n,f),o.children.forEach((u,a)=>{j({parentElement:i,treeSlot:e,mountIndex:n.concat([a]),root:u})}),d&&d(i);return}if(B(o)){let i=o,c=[];x(e,n,E({renderChild:o,domNode:null,onUnmount:c}));let d=i.observe(f=>{if(f.type==="init"){let{items:u}=f;u.forEach((a,p)=>{j({parentElement:t,treeSlot:e,mountIndex:n.concat([p]),root:a})})}else if(f.type!=="sort"){if(f.type==="splice"){let{count:u,index:a,items:p}=f,U=Math.min(u,p.length),L=u-U,S=p.length-U,$=k(e,n.concat([a]),u,p.map(l=>E({renderChild:null,domNode:null,onUnmount:[]})));p.forEach((l,s)=>{j({parentElement:t,treeSlot:e,mountIndex:n.concat([a+s]),root:l})})}}});A(i),c.push(d),c.push(()=>{R(i)});return}if(y(o)){let i=o,c=[],d=J(V(()=>{let f=i(),{immediateParent:u,childIndex:a}=I(e,n),p=x(e,n,E({renderChild:f,domNode:null,onUnmount:[()=>R(d)]}));A(d),j({parentElement:t,treeSlot:e,mountIndex:n.concat([0]),root:f,replacedTreeSlot:p})}),`view:calc:${JSON.stringify(n)}`);d();return}if(pe(o)){let i=o.component,c=J(V(()=>{let d=[],f=[],u=i(Object.assign(Object.assign({},o.props||{}),{children:o.children}),{onUnmount:a=>{d.push(a)},onMount:a=>{f.push(a)}});x(e,n,E({renderChild:u,domNode:null,onUnmount:[()=>R(c),...d]})),A(c),j({parentElement:t,treeSlot:e,mountIndex:n.concat([0]),root:u}),f.forEach(a=>a())}),`view:component:${o.component.name}:${JSON.stringify(n)}`);c();return}if(Array.isArray(o)){let i=o;x(e,n,E({renderChild:o,domNode:null,onUnmount:[]})),i.forEach((c,d)=>{j({parentElement:t,treeSlot:e,mountIndex:n.concat([d]),root:c})});return}if(typeof o=="function"){x(e,n,E({renderChild:o,domNode:null,onUnmount:[]}));return}ue(o,"unexpected render type")}function be(t,e){j({parentElement:t,treeSlot:E({renderChild:null,domNode:t,onUnmount:[]}),mountIndex:[0],root:e})}var ve=({children:t})=>t;var Oe=ge,Se="development",W=[],ee=new Map,Q=new WeakMap;function g(t){var e,n,o;return B(t)?`coll:${(e=Q.get(t))!==null&&e!==void 0?e:"?"}`:y(t)?`${de(t)?"eff":"comp"}:${(n=Q.get(t))!==null&&n!==void 0?n:"?"}`:`model:${(o=Q.get(t.model))!==null&&o!==void 0?o:"?"}:${String(t.key)}`}var D=new _,h=new _;function _e(){D=new _,W=[],ee=new Map,h=new _}function J(t,e){return Q.set(t,e),t}function je(t){if(typeof t!="object"||!t)throw new T("model must be provided an object");let e=new Map,n=new Proxy(t,{get(o,r){if(r===w)return"model";let i=e.get(r);return i||(i={model:n,key:r},e.set(r,i)),te(i),o[r]},set(o,r,i){let c=e.get(r);return c||(c={model:n,key:r},e.set(r,c)),P(c),o[r]=i,!0}});return n}function Ne(t){if(!Array.isArray(t))throw new T("collection must be provided an array");let e=new Map,n=[];function o(l){n.forEach(s=>{s(l)})}function r(l,s,...m){if(s<1&&m.length===0)return[];let v=t.length,F=t.splice(l,s,...m),z=t.length;if(o({type:"splice",index:l,count:s,items:m}),v===z)for(let C=l;C<l+s;++C)P(S(C.toString()));else{for(let C=l;C<Math.max(z,v);++C)P(S(C.toString()));P(S("length"))}return F}function i(l){return r(t.length-1,1)[0]}function c(l){return r(0,1)[0]}function d(...l){return r(t.length,0,...l),t.length}function f(...l){return r(0,0,...l),t.length}function u(l){return t.sort(l),n.forEach(s=>{s({type:"sort"})}),$}function a(l){let s=Ne(t.map(l)),m=$.observe(v=>{if(v.type!=="sort"&&v.type==="splice"){let{index:F,count:z,items:C}=v;s.splice(F,z,...C.map(l))}});return s}function p(l,s){r(l,1,s)}function U(l){return n.push(l),l({type:"init",items:t}),()=>{n=n.filter(s=>s!==l)}}let L={splice:r,pop:i,shift:c,push:d,unshift:f,observe:U,sort:u,mapView:a};function S(l){let s=e.get(l);return s||(s={model:$,key:l},e.set(l,s)),s}let $=new Proxy(t,{get(l,s){if(s in L)return L[s];if(s===w)return"collection";let m=S(s);return $e($,m),te(m),l[s]},set(l,s,m){if(s in L)return b("Overriding certain collection methods not supported",s),!1;let v=Number(s);if(!isNaN(v)&&v<=t.length)return p(v,m),!0;let F=S(s);return P(F),l[s]=m,!0},deleteProperty(l,s){if(s in L)return b("Deleting certain collection methods not supported",s),!1;let m=S(s);return P(m),delete l[s],!0}});return $}function Ue(t){return xe(t,!1)}function V(t){return xe(t,!0)}function xe(t,e){if(typeof t!="function")throw new T("calculation must be provided a function");let n,o=()=>{n=void 0},r=(e?le:ce)(function(){if(e||te(r),n)return n.result;let c=h.getReverseDependencies(r).map(f=>[f,r]);if(h.removeEdges(c),W.push(r),n={result:t()},W.pop()!==r)throw new T("Active calculation stack inconsistency!");return n.result});return h.addNode(r),ee.set(r,o),r}function te(t){let e=W[W.length-1];e&&(h.addNode(t),h.hasNode(e)||h.addNode(e),h.addEdge(t,e)&&N("New global dependency",g(t),"->",g(e)))}function $e(t,e){h.addNode(t),h.addNode(e),h.addEdge(t,e)&&N("New global collection dependency",g(t),"->",g(e))}function P(t){let e=n=>{D.addNode(n),h.getDependencies(n).forEach(r=>{D.hasNode(r)||e(r),D.addEdge(n,r)&&N("New local dependency",g(t),"->",g(r)),X||(X=!0,Re())})};e(t)}var X=!1,ne=new Set;function Ae(t){return ne.add(t),()=>ne.delete(t)}function Re(){ne.forEach(t=>{try{t()}catch(e){K(e,"unhandled exception in subscriber")}})}function De(){if(!X)return;X=!1;let t=D;D=new _,t.visitTopological(e=>{if(y(e)){N("flushing calculation",g(e));let n=ee.get(e);n&&n(),e()}else N("flushing model",g(e))}),h.garbageCollect().forEach(e=>{y(e)?N("GC calculation",g(e)):N("GC model",g(e))})}function A(t){N("retain",g(t)),h.hasNode(t)||h.addNode(t),h.retain(t)}function R(t){N("release",g(t)),h.release(t)}function Pe(){return h.graphviz((t,e)=>`${t}
${g(e)}`)}return Le;})();
//# sourceMappingURL=index.min.js.map
